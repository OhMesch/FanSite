<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Gallery</title>

    <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.js"></script>
    <script src="https://unpkg.com/packery@2/dist/packery.pkgd.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div id="header">
        <h1>★ ERIC JOHNSON OFFICIAL FAN CLUB ★</h1>
        <p>Upload your fav photos here!</p>
    </div>

    <div id="upload-section">
        <!-- <input type="file" id="fileInput">
        <button onclick="uploadImage()">Upload</button> -->
        <!-- <label for="fileInput">
            <i class="fa-solid fa-upload" style="font-size: xx-large"></i>
            <input type="file" accept="image/*" oninput="uploadImage()" id="fileInput" style="display: none">
        </label>
        <label for="cameraInput">
            <i class="fa-solid fa-camera" style="font-size: xx-large"></i>
            <input type="file" accept="image/*" capture="camera" oninput="uploadImage()" id="cameraInput" style="display: none">
        </label> -->
        <label for="fileInput">
            <i class="fa-solid fa-camera" style="font-size: xx-large"></i>
            <input type="file" accept="image/*" oninput="uploadImage()" id="fileInput" style="display: none">
        </label>
    </div>

    <div id="gallery">
        <div class="grid-sizer"></div>
    </div>

    <div class="modal" id="imageModal">
        <span class="close">&times;</span>
        <img class="modal-content" id="modalImage">
        <div id="caption"></div>
    </div>

    <style>
        html {
            background-image: url('./static/imgs/background.jpg');
            background-size: 2%;
            background-repeat: repeat;
            overscroll-behavior: none;
        }
        body {
            margin: 0;
        }
        #header {
            background-image: url("./static/imgs/party_small.gif");
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            margin: 0;
        }
        #header h1 {
            font-family: 'SuperMario256', sans-serif;
            font-size: 400%;
            color: gold;
            margin: 0 0 50vh 0;
            padding: 2vh 0 0 2vw;
        }
        #header p {
            font-family: 'funtime', sans-serif;
            font-size: 200%;
            color: goldenrod;
            text-align: center;
            margin: 0 0 5vh 0;
            padding-bottom: 2vh;
        }
        #upload-section {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            width: fit-content;
            padding: 16px;
            background-color: aqua;
        }
        #gallery {
            margin: 0 auto;
            text-align: center;
        }
        .grid-sizer,
        .grid-item { 
            width: calc(25%);
            padding: .5%;
            margin: 0 auto;
            vertical-align: middle;
        }
        .grid-item-portrait {
            /* height: 60vh;
            width: auto; */
        }
        .grid-item-landscape {
            width: calc(25%*16/9);
        }
        .modal {
            display: none; 
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.9); 
            overflow: auto;
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
    
            max-height: 100%;
            max-width: 100%;
            
            /* Ensure the image scales while preserving its aspect ratio */
            object-fit: contain;

            z-index: -1;
        }
        .no-scroll {
            overflow: hidden;
            height: 100%;
        }
        .close {
            position: absolute;
            top: 10px;
            right: 25px;
            color: #f1f1f1;
            font-size: 35px;
            cursor: pointer;
        }
        @font-face {
            font-family: 'SuperMario256';
            src: url('./static/fonts/SuperMario256.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'funtime';
            src: url('./static/fonts/funtime.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
    </style>

    <script>
        let pckry = new Packery( document.getElementById('gallery'), {
            itemSelector: '.grid-item',
            columnWidth: '.grid-sizer',
            percentPosition: true
        });
        window.onload = function() {
            fetch('/get-images')
            .then(response => response.json())
            .then(images => {
                let gallery = document.getElementById('gallery');
                for (let image of images) {
                    gallery.appendChild(createImgElement(`/uploads/${image}`));
                }
                imagesLoaded(gallery).progress( function() {
                    pckry.layout();
                });
            });

            assignUserCookieIfNone();
        }

        //check shadow ban using cookies
        function uploadImage(event) {
            let fileInput = document.getElementById('fileInput');
            let file = fileInput.files[0];

            //assert it's an image
            if(!file.type.startsWith('image/')) {
                alert('Please upload an image');
                return;
            }

            //submit the image
            let formData = new FormData();
            formData.append('file', file);
            formData.append('uuid', getUserCookie());

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    const gallery = document.getElementById('gallery');
                    const upload = createImgElement(`/uploads/${file.name}`);
                    const fragment = document.createDocumentFragment();
                    fragment.appendChild(upload);
                    gallery.insertBefore(fragment, gallery.firstElementChild.nextSibling);
                    pckry.prepended(fragment);
                    pckry.layout();
                    log(`${getUserCookie()} uploaded ${file.name}`);
                }
            });
        }

        function createImgElement(src) {
            let img = new Image();
            img.onload = function() {
                this.classList = 'grid-item';
                if (this.height > this.width) {
                    this.classList += ' grid-item-portrait';
                } else {
                    this.classList += ' grid-item-landscape';
                }
            }
            img.src = src;

            let modalWrapper = document.getElementById("imageModal");
            let modalImage = document.getElementById("modalImage");
            let modalCaption = document.getElementById("caption");
            img.onclick = function () {
                document.body.classList.add('no-scroll');
                modalWrapper.style.display = "block";
                modalImage.src = this.src;
                modalCaption.innerHTML = this.alt;
            }

            var span = document.getElementsByClassName("close")[0];
            span.onclick = closeModal();
            modalWrapper.onclick = function(event) {
                if (event.target !== modalImage && event.target !== modalCaption) {
                    closeModal();
                }
            }

            return img;
        }

        function closeModal() {
            document.getElementById("imageModal").style.display = "none";
            document.body.classList.remove('no-scroll');
        }

        function log(logMessage) {
            let formData = new FormData();
            formData.append('message', logMessage);
            fetch('/log', {
                method: 'POST',
                body: formData
            });
        }

        USER_COOKIE_NAME = 'uuid';
        COOKIE_LENGTH = 36;
        function assignUserCookieIfNone() {
            if (!getUserCookie()) {
                const uuid = generateUUID();
                document.cookie = USER_COOKIE_NAME + "=" + (generateUUID() || "") + "; path=/";
                log("Assigned new user cookie to " + uuid);
            }
        }

        function getUserCookie() {
            const decodedCookies = decodeURIComponent(document.cookie);
            const cookieArray = decodedCookies.split(';');
            for(let i = 0; i < cookieArray.length; i++) {
                const c = cookieArray[i].trim();
                if (c.indexOf(USER_COOKIE_NAME) === 0) {
                    return c.substring(name.length+`${USER_COOKIE_NAME}=`.length, c.length);;
                }
            }
            return null;
        }

        function generateUUID() {
            let template = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx';
            console.assert(template.length === COOKIE_LENGTH, 'UUID template length is not correct');
            return template.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0,
                    v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
    </script>
</body>
</html>
